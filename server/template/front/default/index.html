

<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>监控</title>
    <link rel="shortcut icon" type="image/png" href="/static/logo.svg?v20210804" />


    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta http-equiv="Content-Language" content="zh" />


    <link rel="stylesheet" type="text/css" href="https://cdn.staticfile.org/semantic-ui/2.4.1/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.staticfile.org/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/static/semantic-ui-alerts.min.css">
    <link rel="stylesheet" href="/static/theme-hotaru/css/core.css?v202012121912" type="text/css">
    <link rel="stylesheet" href="/static/theme-hotaru/css/main.css?v202101171153" type="text/css">
    <link rel="stylesheet" href="/static/theme-hotaru/css/darkmode.css?v202103021121" type="text/css">

    <script>

        window.onload = function(){
            $('#sun').click();
        }
    </script>

</head>

<body>
<section class="hotaru-cover">
    <div class="container" style="text-align: center;">
        <h1 style="line-height: 8rem;">
            <strong>监控</strong>
        </h1>
    </div>
</section>

<div id="app">
    <div class="container">
        <table class="table table-striped">
            <thead>
            <tr>
                <th>状态</th>
                <th>名称</th>
                <th>系统</th>
                <th>地区</th>
                <th>在线</th>
                <th>网络(B/s) ↓|↑</th>
                <th>流量(B) ↓|↑</th>
                <th>CPU</th>
                <th>RAM</th>
                <th>硬盘</th>
            </tr>
            </thead>
            <tbody id="servers" style="text-align:center;">
            <tr v-for='server in servers' :id="server.id">
                <td>
                    <div class="progress">
                        <div :class="'state-'+ (server.live?'online':'offline')">
                            <small>{{server.live?'运行中':'已离线'}}</small>
                        </div>
                    </div>
                </td>
                <td>{{server.name}}</td>
                <td>{{server.info?server.info.platform:'-'}}</td>
                <td>{{server.info?server.info.CountryCode:'-'}}</td>
                <td>{{server.state?window.utils.secondToDate(server.state.uptime):'-'}}</td>
                <td>{{server.state?window.utils.readableBytes(server.state.net_in_speed)+'/s|'+window.utils.readableBytes(server.state.net_out_speed)+'/s':'-'}}
                </td>
                <td>{{server.state?window.utils.readableBytes(server.state.net_in_transfer)+'|'+window.utils.readableBytes(server.state.net_out_transfer):'-'}}
                </td>
                <td>
                    <div v-if="server.state" :class="formatPercent(server.live,server.state.cpu, 100).class">
                        <div class="bar" :style="formatPercent(server.live,server.state.cpu, 100).style">
                            <small>{{formatPercent(server.live,server.state.cpu,100).percent}}%</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div v-if="server.state"
                         :class="formatPercent(server.live,server.state.mem_used, server.info.mem_total).class">
                        <div class="bar"
                             :style="formatPercent(server.live,server.state.mem_used, server.info.mem_total).style">
                            <small>{{parseInt(server.state?server.state.mem_used/server.info.mem_total*100:0)}}%</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div v-if="server.state"
                         :class="formatPercent(server.live,server.state.disk_used, server.info.disk_total).class">
                        <div class="bar"
                             :style="formatPercent(server.live,server.state.disk_used, server.info.disk_total).style">
                            <small>{{parseInt(server.state?server.state.disk_used/server.info.disk_total*100:0)}}%</small>
                        </div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="page-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-4 col-sm-4" v-for='server in servers' :id="server.id">
                    <div class="panel panel-block panel-block-sm panel-location">
                        <div class="location-header">
                            <h3 class="h4">
                                &nbsp;{{server.name}}</h3>
                            <i class="zmdi zmdi-check-circle text-success"></i>
                        </div>
                        <div class="location-progress">
                            <div
                                    :class="formatPercent(server.live,window.utils.mergeUsage(server.state, server.info),100).class">
                                <div class="bar"
                                     :style="formatPercent(server.live,window.utils.mergeUsage(server.state, server.info),100).style">
                                </div>
                            </div>
                        </div>
                        <ul class="location-info list-styled">
                            <li><span class="list-label">网络:</span>
                                {{server.state?window.utils.formatByteSize(server.state.net_in_speed)+'/s|'+window.utils.formatByteSize(server.state.net_out_speed)+'/s':'-'}}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="sidebar-container">
    <ul>
        <li id='sun'><i class="fas fa-sun" title='白昼模式'></i><span>白昼模式</span></li>
        <li id='moon'><i class="fas fa-moon" title='暗黑模式'></i><span>暗黑模式</span></li>
    </ul>
</div>
<footer>
    <p style="text-align:center;padding: 15px;">Powered by <a href="https://github.com/naiba/nezha">哪吒监控</a> build ·
        v0.14.7
        <a href="/service">服务</a>
        <a href="/server">管理后台</a>
    </p>
</footer>
<script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/semantic-ui/2.4.1/semantic.min.js"></script>
<script src="/static/semantic-ui-alerts.min.js"></script>
<script src="/static/utils.js"></script>
<script src="https://cdn.staticfile.org/vue/2.6.14/vue.min.js"></script>
<script>
    $(function(){
        $('#sun').click(function(){
            $('body').removeClass('dark');
        });
        $('#moon').click(function(){
            $('body').addClass('dark');
        })
    })



    var statusCards = new Vue({
        el: '#app',
        // delimiters: ['{{', '}}'],
        data: {
            servers: [],
            cache: [],
        },
        mounted() {
            this.getServerList()
            this.troggleDarkMode();
        },
        methods: {
            formatPercent(live, used, total) {
                const percent = live ? (parseInt(used / total * 100) || 0) : -1
                if (!this.cache[percent]) {
                    this.cache[percent] = {
                        class: {
                            ui: true,
                            progress: true,
                        },
                        style: {
                            'transition-duration': '300ms',
                            'min-width': 'unset',
                            width: percent + '% !important',
                        },
                        percent,
                    }
                    if (percent < 0) {
                        this.cache[percent].style['background-color'] = 'slategray'
                        this.cache[percent].class.offline = true
                    } else if (percent < 51) {
                        this.cache[percent].style['background-color'] = '#0a94f2'
                        this.cache[percent].class.fine = true
                    } else if (percent < 81) {
                        this.cache[percent].style['background-color'] = 'orange'
                        this.cache[percent].class.warning = true
                    } else {
                        this.cache[percent].style['background-color'] = 'crimson'
                        this.cache[percent].class.error = true
                    }
                }
                return this.cache[percent]
            },
            troggleDarkMode() {
                const hour = new Date(Date.now()).getHours()
                if (hour > 17 || hour < 4) {
                    document.body.classList.add('dark');
                }
            },

            getServerList(){
                fetch("/api/v1/server").then(res => res.json()).then(res => {
                    this.servers = res.data
                })
            },

            addServer(server){
                let serverIndex = null;
                for (let i = 0; i < this.servers.length; i++) {
                    if (server.id == this.servers[i].id){
                        serverIndex = i
                    }
                }
                if (serverIndex != null){
                    let serverData = {
                        ...this.servers[serverIndex],
                        ...server
                    }
                    this.$set(this.servers, serverIndex, serverData)
                    console.log("addServer", serverIndex, serverData);
                }else{
                    this.servers.push(server)
                }
            },
            offlineServer(serverId){
                let server = this.getServer(serverId);
                server.live = false
            },
            updateServer(serverId,state){
                let server = this.getServer(serverId);
                if (!server) return;
                server.state = state
            },
            getServer(serverId){
                for (const server of this.servers) {
                    if (server.id == serverId){
                        return server;
                    }
                }
                return null;
            }
        }
    })

    console.log(statusCards);


    const wsProtocol = window.location.protocol == "https:" ? "wss" : "ws"
    let canShowError = true;
    function connect() {
        const ws = new WebSocket(wsProtocol + '://' + window.location.host + '/ws/web');
        ws.onopen = function (evt) {
            canShowError = true;
            $.suiAlert({
                title: '实时通道建立',
                description: '可以实时获取最新监控数据啦',
                type: 'success',
                time: '2',
                position: 'top-center',
            });
        }
        ws.onmessage = function (evt) {
            const data = JSON.parse(evt.data)
            // 有服务上线
            if (data.message_type === 2000){
                statusCards.addServer(data.message)
            }else if (data.message_type === 2001){
                // 服务离线
                statusCards.offlineServer(data.message)
            }else if (data.message_type === 2002){
                // 服务离线
                statusCards.updateServer(data.message.id, data.message.state)
            }
        }
        ws.onclose = function () {
            if (canShowError) {
                canShowError = false;
                $.suiAlert({
                    title: '实时通道断开',
                    description: '无法实时获取最新监控数据咯',
                    type: 'warning',
                    time: '2',
                    position: 'top-center',
                });
            }
            setTimeout(function () {
                connect()
            }, 3000);
        }
        ws.onerror = function () {
            ws.close()
        }
    }
    connect()
</script>
</body>

</html>
